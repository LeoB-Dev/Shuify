<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>No-Framework JavaScript Drag-n-Drop</title>

    <style>
        body {
            background-color: lightblue;
            height: 100dvh;
        }

        [data-pickzone] {
            border: 3px dotted black;
            gap: 1rem;
            margin-top: 1rem;
            min-height: 100px;
        }

        [data-dropzone] {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item {
            cursor: move;
            width: 50px;
            height: auto;
            touch-action: none;
            user-select: none;
            pointer-events: auto;
            -webkit-user-drag: none;
            -moz-user-drag: none;
            z-index: 1;
        }

        .item.dragging {
            position: absolute;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
            transform: scale(1.2);
        }

        .item.clone {
            /* background: #eee; */
            border: 2px solid black;
        }

        #central-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .room-container {
            aspect-ratio: 1 / 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 0;
        }

        #room-right {
            height: 100px;
            width: 100px;
            background-color: #d3d3d3;
            position: absolute;
            bottom: 100px;
            transform: rotate(90deg) skewX(-30deg) scaleY(0.864);
            transform-origin: bottom right;
        }

        #room-left {
            height: 100px;
            width: 100px;
            background-color: #bebebe;
            position: absolute;
            bottom: 100px;
            transform: rotate(-30deg) skewX(-30deg) scaleY(0.864);
            transform-origin: bottom right;
        }

        #room-bottom {
            height: 100px;
            width: 100px;
            position: absolute;
            background-color: #54513f;
            bottom: 100px;
            transform: rotate(210deg) skew(-30deg) scaleY(0.864);
            transform-origin: bottom right;
        }
    </style>
</head>

<body>
    <div id="intial-container" data-pickzone data-dropzone>
        <img id="bed" class="item leftright-deny" src="../iso-room-dnd/bed.png">
        <img id="art" class="item bottom-deny" src="../iso-room-dnd/art.png">
    </div>

    <div id="central-content">
        <div class="room-container">
            <div id="room-right" data-dropzone></div>
            <div id="room-left" data-dropzone></div>
            <div id="room-bottom" data-dropzone></div>
        </div>
    </div>

    <script>

        function roomLeftDropNScale(e) {
            e.classList.add('dropped');
            console.log('child element appended to left dropzone');
            e.setAttribute("style", "transform: scaleY(1.157) skew(30deg) rotate(30deg);");
            // e.setAttribute("src", e.src.replace("-rev.png", ".png"));
        }

        function roomRightDropNScale(e) {
            e.classList.add('dropped');
            e.setAttribute("style", "transform: scaleY(1.157) skew(30deg) rotate(-90deg);");
            console.log('child element appended to right dropzone');
            // e.setAttribute("src", e.src.replace(".png", "-rev.png"));
        }

        function roomBottomDropNScale(e) {
            e.classList.add('dropped');
            e.setAttribute("style", "transform: scaleY(1.157) skew(30deg) rotate(-210deg);");
            console.log('child element appended to right dropzone');
            // e.style.position = "fixed";
        }

        // function saveState() {
        //     const positions = {};
        //     document.querySelectorAll('.item').forEach(item => {
        //         positions[item.id] = item.parentElement.id; // create key value pair
        //     });
        //     localStorage.setItem('dragPositions', JSON.stringify(positions));
        // }

        const items = document.querySelectorAll('.item');
        const dropzones = document.querySelectorAll('[data-dropzone]'); // saves as an array

        [...items].forEach((item) => { // spread operator turns items into an array here

            item.addEventListener('pointerdown', (event) => {

                item.style.left = `${item.getBoundingClientRect().left}px`;
                item.style.top = `${item.getBoundingClientRect().top}px`;

                const clone = item.cloneNode();
                clone.classList.add('clone');


                item.before(clone);
                item.style.pointerEvents = 'none';

                item.classList.add('dragging');
                document.body.append(item);

                item.setPointerCapture(event.pointerId);

                const up = () => {

                    clone.after(item);
                    clone.remove();

                    /* Add styles here and possibily logic*/

                    dropzones.forEach(zone => {
                        // First condition: room-bottom
                        if (zone.id === "room-bottom" && item.id === "bed") {
                            console.log('child element appended to bottom dropdropZone');
                            roomBottomDropNScale(item);
                            // item.style.left = "20%";
                            // item.style.top = "20%";
                            // saveState();
                        }

                        else if (zone.id === "room-left") {
                            if (item.classList.contains("bottom-deny") && item.id === "art") {
                                roomLeftDropNScale(item);
                                // artWallPos(item);
                                // saveState();
                            }
                        }

                        // else if (zone.id === "room-right") {
                        //     if (item.classList.contains("bottom-deny") && item.id === "art") {
                        //         roomRightDropNScale(item);
                        //     }
                        // }
                    });


                    item.style.left = '';
                    item.style.top = '';
                    item.classList.remove('dragging');
                    item.style.pointerEvents = '';

                    item.removeEventListener('pointerup', up);
                    item.removeEventListener('pointermove', move);
                    item.releasePointerCapture(event.pointerId);
                };


                const move = (event) => {

                    item.style.left =
                        `${parseFloat(item.style.left) + event.movementX}px`;
                    item.style.top =
                        `${parseFloat(item.style.top) + event.movementY}px`;

                    const hitTest = document.elementFromPoint(
                        parseFloat(item.style.left),
                        parseFloat(item.style.top)
                    );

                    const dropzone = hitTest.closest('[data-dropzone]');
                    if (!dropzone) return;

                    if (clone.closest('[data-dropzone]') !== dropzone) {
                        dropzone.append(clone);
                        // --- apply the same styles that the real item will get ---
                        if (item.id === "bed" && dropzone.id === "room-bottom") {
                            roomBottomDropNScale(clone); // style the clone same as the real item
                        }
                        else if (item.id === "iso-art" && dropzone.id === "room-left") {
                            roomLeftDropNScale(clone);

                        }

                        return;
                    }

                    const dropzoneChildren = [...dropzone.children];
                    const cloneIndex = dropzoneChildren.indexOf(clone);

                    dropzoneChildren.forEach((child, index) => {
                        if (hitTest === clone) return;

                        if (hitTest === child) {
                            if (cloneIndex < index) {
                                child.after(clone);
                            } else {
                                child.before(clone);
                            }
                        }
                    });
                };

                item.addEventListener('pointerup', up);
                item.addEventListener('pointermove', move);
            });
        });

        // window.addEventListener('load', () => {
        //     const positions = JSON.parse(localStorage.getItem('dragPositions')) || {};
        //     for (const [id, parent] of Object.entries(positions)) {
        //         const element = document.getElementById(id);
        //         const parentElement = document.getElementById(parent);
        //         if (parentElement) {
        //             parentElement.appendChild(element);
        //             // addIsoStyles(parentElement, element);
        //         }
        //     }
        // });  //Saves bed wrong way round (could be related to clone)
    </script>
</body>

</html>

<!--Source: https://www.youtube.com/watch?v=QVgEzUXeT-I&t=1573s

Notes: as soon as item is dragged over container it is added to it, it doesn't need to be dropped, may prove a bad choice for my room-->